name: EPG Analytics Update

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ (UTCæ—¶é—´)
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/epg-analytics.yml'

jobs:
  analyze-epg:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        persist-credentials: false
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests lxml beautifulsoup4 pandas
        
    - name: Analyze EPG data
      env:
        EPG_URL: https://raw.githubusercontent.com/zzq1234567890/epg/main/twepg.xml
      run: |
        python << 'EOF'
import sys
import requests
from lxml import etree
from datetime import datetime, timedelta
import pandas as pd
import re

def fetch_epg_data(url):
    """è·å–EPG XMLæ•°æ®"""
    try:
        response = requests.get(url, timeout=30)
        response.raise_for_status()
        return response.content
    except Exception as e:
        print(f"Error fetching EPG data: {e}")
        sys.exit(1)

def analyze_channels(xml_data):
    """åˆ†æEPGæ•°æ®ï¼Œæå–é¢‘é“ä¿¡æ¯"""
    try:
        # è§£æXML
        root = etree.fromstring(xml_data)
        
        channels = []
        
        # æ‰¾åˆ°æ‰€æœ‰é¢‘é“èŠ‚ç‚¹
        for channel in root.xpath('.//channel'):
            channel_info = {}
            
            # è·å–é¢‘é“åç§°
            display_name = channel.find('display-name')
            if display_name is not None and display_name.text:
                channel_info['name'] = display_name.text.strip()
            else:
                channel_info['name'] = 'Unknown'
            
            # ç»Ÿè®¡è¯¥é¢‘é“çš„èŠ‚ç›®æ•°é‡
            programs = root.xpath(f'.//programme[@channel="{channel.get("id")}"]')
            channel_info['program_count'] = len(programs)
            
            # è®¡ç®—èŠ‚ç›®æ—¶é—´èŒƒå›´ï¼ˆå¤©æ•°ï¼‰
            if programs:
                start_times = []
                end_times = []
                
                for prog in programs[:50]:  # åªæ£€æŸ¥å‰50ä¸ªèŠ‚ç›®æé«˜æ€§èƒ½
                    start = prog.get('start')
                    stop = prog.get('stop')
                    
                    if start:
                        try:
                            # è§£æEPGæ—¶é—´æ ¼å¼: YYYYMMDDHHMMSS +0000
                            start_dt = datetime.strptime(start[:14], '%Y%m%d%H%M%S')
                            start_times.append(start_dt)
                        except:
                            pass
                    
                    if stop:
                        try:
                            end_dt = datetime.strptime(stop[:14], '%Y%m%d%H%M%S')
                            end_times.append(end_dt)
                        except:
                            pass
                
                if start_times:
                    min_date = min(start_times)
                    max_date = max(start_times)
                    
                    if end_times:
                        max_date = max(max_date, max(end_times))
                    
                    days_span = (max_date - min_date).days + 1
                    channel_info['days_span'] = max(1, days_span)
                    
                    # æ ¼å¼åŒ–æ—¥æœŸèŒƒå›´
                    channel_info['date_range'] = f"{min_date.strftime('%Y-%m-%d')} è‡³ {max_date.strftime('%Y-%m-%d')}"
                else:
                    channel_info['days_span'] = 0
                    channel_info['date_range'] = 'N/A'
            else:
                channel_info['days_span'] = 0
                channel_info['date_range'] = 'N/A'
            
            channels.append(channel_info)
        
        return channels
    except Exception as e:
        print(f"Error analyzing EPG data: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

def generate_markdown_table(channels):
    """ç”ŸæˆMarkdownè¡¨æ ¼"""
    if not channels:
        return "## EPG é¢‘é“æ•°æ®\n\næš‚æ— æ•°æ®"
    
    # æ’åºï¼šæŒ‰èŠ‚ç›®æ•°é‡é™åºï¼Œé¢‘é“åç§°å‡åº
    sorted_channels = sorted(channels, key=lambda x: (-x['program_count'], x['name']))
    
    # åˆ›å»ºDataFrameä»¥ä¾¿å¤„ç†
    df = pd.DataFrame(sorted_channels)
    
    # ç»Ÿè®¡æ‘˜è¦
    total_channels = len(df)
    total_programs = df['program_count'].sum()
    avg_programs = df['program_count'].mean()
    
    table = f"""## ğŸ“º EPG é¢‘é“æ•°æ®åˆ†æ

**æœ€åæ›´æ–°:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
**æ•°æ®æ¥æº:** [twepg.xml](https://github.com/zzq1234567890/epg/blob/main/twepg.xml)

### ğŸ“Š æ•°æ®æ‘˜è¦
- **æ€»é¢‘é“æ•°:** {total_channels} ä¸ª
- **æ€»èŠ‚ç›®æ•°:** {total_programs:,} ä¸ª
- **å¹³å‡æ¯ä¸ªé¢‘é“èŠ‚ç›®æ•°:** {avg_programs:.1f} ä¸ª

### ğŸ¬ é¢‘é“è¯¦ç»†æ•°æ®

| åºå· | é¢‘é“åç§° | èŠ‚ç›®æ•°é‡ | æ—¶é—´è·¨åº¦(å¤©) | æ—¥æœŸèŒƒå›´ |
|------|----------|----------|--------------|----------|
"""
    
    for i, row in enumerate(df.itertuples(), 1):
        # æˆªå–è¿‡é•¿çš„é¢‘é“åç§°
        channel_name = row.name
        if len(channel_name) > 30:
            channel_name = channel_name[:27] + "..."
        
        table += f"| {i} | {channel_name} | {row.program_count:,} | {row.days_span} | {row.date_range} |\n"
    
    # æ·»åŠ ç»Ÿè®¡æ•°æ®è¡Œ
    table += f"""
### ğŸ“ˆ ç»Ÿè®¡æŒ‡æ ‡
- **æœ€å¤šèŠ‚ç›®çš„é¢‘é“:** {df.iloc[0]['name']} ({df.iloc[0]['program_count']:,} ä¸ªèŠ‚ç›®)
- **æœ€å°‘èŠ‚ç›®çš„é¢‘é“:** {df.iloc[-1]['name']} ({df.iloc[-1]['program_count']} ä¸ªèŠ‚ç›®)
- **æœ€å¤§æ—¶é—´è·¨åº¦:** {df['days_span'].max()} å¤©
1ï¸âƒ£ æ•°æ®æ¯æ—¥è‡ªåŠ¨æ›´æ–°
ğŸ“ˆ æŒ‰èŠ‚ç›®æ•°é‡æ’åº
â° ä½¿ç”¨ UTC æ—¶é—´
"""
    
    return table

def update_readme(markdown_content):
    """æ›´æ–°README.mdæ–‡ä»¶"""
    readme_path = 'README.md'
    
    try:
        # è¯»å–ç°æœ‰çš„README
        with open(readme_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # æŸ¥æ‰¾EPGè¡¨æ ¼éƒ¨åˆ†
        epg_start = content.find('## ğŸ“º EPG é¢‘é“æ•°æ®åˆ†æ')
        
        if epg_start != -1:
            # æ‰¾åˆ°ä¸‹ä¸€ä¸ªä¸»è¦ç« èŠ‚çš„å¼€å§‹
            next_section = re.search(r'\n## [^#]', content[epg_start:])
            if next_section:
                epg_end = epg_start + next_section.start()
                # æ›¿æ¢EPGéƒ¨åˆ†
                new_content = content[:epg_start] + markdown_content + content[epg_end:]
            else:
                # å¦‚æœEPGéƒ¨åˆ†æ˜¯æœ€åä¸€éƒ¨åˆ†
                new_content = content[:epg_start] + markdown_content
        else:
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°EPGéƒ¨åˆ†ï¼Œæ·»åŠ åˆ°æ–‡ä»¶æœ«å°¾
            new_content = content.rstrip() + '\n\n' + markdown_content
        
        # å†™å…¥æ›´æ–°åçš„å†…å®¹
        with open(readme_path, 'w', encoding='utf-8') as f:
            f.write(new_content)
        
        print("README.md æ›´æ–°æˆåŠŸï¼")
        
    except Exception as e:
        print(f"Error updating README.md: {e}")
        # å¦‚æœREADMEä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
        with open(readme_path, 'w', encoding='utf-8') as f:
            f.write(f"# EPG æ•°æ®åˆ†æ\n\n{markdown_content}")
        print("åˆ›å»ºäº†æ–°çš„ README.md æ–‡ä»¶")

def main():
    print("å¼€å§‹è·å–EPGæ•°æ®...")
    xml_data = fetch_epg_data('${{ env.EPG_URL }}')
    
    print("åˆ†æé¢‘é“æ•°æ®...")
    channels = analyze_channels(xml_data)
    
    print("ç”ŸæˆMarkdownè¡¨æ ¼...")
    markdown_table = generate_markdown_table(channels)
    
    print("æ›´æ–°README.md...")
    update_readme(markdown_table)
    
    print(f"å®Œæˆï¼åˆ†æäº† {len(channels)} ä¸ªé¢‘é“ã€‚")

if __name__ == "__main__":
    main()
EOF

    - name: Commit and Push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ“ˆ æ›´æ–°EPGæ•°æ®åˆ†ææŠ¥å‘Š $(date +'%Y-%m-%d')" && git push)
        
    - name: Create Summary
      run: |
        echo "## EPGåˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æˆåŠŸè·å–å¹¶åˆ†æEPGæ•°æ®" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“Š æ•°æ®å·²æ›´æ–°åˆ°README.md" >> $GITHUB_STEP_SUMMARY
        echo "- â° ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œæ—¶é—´ï¼šæ˜å¤© 02:00 UTC" >> $GITHUB_STEP_SUMMARY