name: æå–é›»è¦–å°åç¨±å’Œç”Ÿæˆåˆ†æå ±å‘Š

on:
  schedule:
    - cron: '45 */1 * * *'   # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:          # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  extract:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Download XML files
        run: |
          curl -L -o twepg.xml https://raw.githubusercontent.com/zzq1234567890/epg/main/twepg.xml
          curl -L -o swepg.xml https://raw.githubusercontent.com/zzq1234567890/epg/main/swepg.xml

      - name: Extract channel names and generate JSON analysis
        run: |
          python <<'EOF'
          import xml.etree.ElementTree as ET
          import json
          from datetime import datetime

          def analyze_epg_data(xml_file):
              try:
                  tree = ET.parse(xml_file)
                  root = tree.getroot()
                  
                  # å­˜å‚¨é¢‘é“ä¿¡æ¯
                  channels_info = {}
                  
                  # ç¬¬ä¸€éï¼šæå–æ‰€æœ‰é¢‘é“åç§°
                  for channel in root.findall('channel'):
                      channel_id = channel.get('id')
                      name = channel.get('display-name') or channel.findtext('display-name') or channel_id
                      
                      if name and name.strip():
                          channels_info[channel_id] = {
                              'name': name.strip(),
                              'program_count': 0,
                              'program_dates': set()
                          }
                  
                  # ç¬¬äºŒéï¼šç»Ÿè®¡èŠ‚ç›®æ•°é‡å’Œæ—¥æœŸ
                  for programme in root.findall('programme'):
                      channel_id = programme.get('channel')
                      start_time = programme.get('start')
                      
                      if channel_id in channels_info:
                          channels_info[channel_id]['program_count'] += 1
                          
                          # æå–æ—¥æœŸéƒ¨åˆ†ï¼ˆå‡è®¾æ ¼å¼ä¸º YYYYMMDDHHMMSSï¼‰
                          if start_time and len(start_time) >= 8:
                              date_str = start_time[:8]  # YYYYMMDD
                              try:
                                  # è½¬æ¢ä¸º YYYY-MM-DD æ ¼å¼
                                  date_obj = datetime.strptime(date_str, '%Y%m%d')
                                  formatted_date = date_obj.strftime('%Y-%m-%d')
                                  channels_info[channel_id]['program_dates'].add(formatted_date)
                              except ValueError:
                                  pass
                  
                  # è½¬æ¢æ—¥æœŸé›†åˆä¸ºæ’åºåçš„åˆ—è¡¨å¹¶è®¡ç®—å¤©æ•°
                  result = []
                  for channel_id, info in channels_info.items():
                      dates = sorted(list(info['program_dates']))
                      days_count = len(dates)
                      
                      # è®¡ç®—æ—¥æœŸèŒƒå›´ï¼ˆæ ¼å¼ï¼š2025-12-01~2025-12-03ï¼‰
                      date_range = "æœªçŸ¥"
                      if dates:
                          start_date = dates[0]
                          end_date = dates[-1]
                          date_range = f"{start_date}~{end_date}"
                      
                      result.append({
                          'channel_id': channel_id,
                          'channel_name': info['name'],
                          'program_count': info['program_count'],
                          'days_count': days_count,
                          'date_range': date_range,
                          'dates_available': dates
                      })
                  
                  # æŒ‰é¢‘é“åç§°æ’åº
                  result.sort(key=lambda x: x['channel_name'])
                  
                  return result
                  
              except Exception as e:
                  print(f"âŒ è§£æ {xml_file} å‡ºé”™: {e}")
                  return []

          # åˆ†æä¸¤ä¸ª XML æ–‡ä»¶
          print("å¼€å§‹åˆ†æ EPG æ•°æ®...")
          tw_data = analyze_epg_data('twepg.xml')
          sw_data = analyze_epg_data('swepg.xml')

          # ç”Ÿæˆç¹ä½“é¢‘é“ JSON
          tw_json = {
              'channels': tw_data,
              'summary': {
                  'total_channels': len(tw_data),
                  'total_programs': sum(ch['program_count'] for ch in tw_data),
                  'date_generated': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                  'data_source': 'twepg.xml'
              }
          }

          # ç”Ÿæˆç®€ä½“é¢‘é“ JSON
          sw_json = {
              'channels': sw_data,
              'summary': {
                  'total_channels': len(sw_data),
                  'total_programs': sum(ch['program_count'] for ch in sw_data),
                  'date_generated': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                  'data_source': 'swepg.xml'
              }
          }

          # ä¿å­˜ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„ JSON æ–‡ä»¶
          with open('traditional_channels.json', 'w', encoding='utf-8') as f:
              json.dump(tw_json, f, ensure_ascii=False, indent=2)

          with open('simplified_channels.json', 'w', encoding='utf-8') as f:
              json.dump(sw_json, f, ensure_ascii=False, indent=2)

          print(f"âœ… ç¹é«”é›»è¦–å°: å…±åˆ†æ {len(tw_data)} ä¸ªé¢‘é“")
          print(f"âœ… ç®€ä½“ç”µè§†å°: å…±åˆ†æ {len(sw_data)} ä¸ªé¢‘é“")
          print(f"âœ… ç¹é«”ç¯€ç›®ç¸½æ•¸: {sum(ch['program_count'] for ch in tw_data)}")
          print(f"âœ… ç®€ä½“ç¯€ç›®ç¸½æ•¸: {sum(ch['program_count'] for ch in sw_data)}")
          print("ğŸ“ å·²ç”Ÿæˆæ–‡ä»¶:")
          print("   - traditional_channels.json (ç¹ä½“é¢‘é“)")
          print("   - simplified_channels.json (ç®€ä½“é¢‘é“)")
          EOF

      - name: Extract channel names (ä¿æŒé¡ºåº)
        run: |
          python <<'EOF'
          import xml.etree.ElementTree as ET

          def extract_names(xml_file, output_file):
              try:
                  tree = ET.parse(xml_file)
                  root = tree.getroot()
                  seen = set()
                  channels = []
                  for c in root.findall('channel'):
                      name = c.get('display-name') or c.findtext('display-name') or c.get('id', '')
                      if name and name.strip() and name not in seen:
                          seen.add(name)
                          channels.append(name.strip())

                  with open(output_file, 'w', encoding='utf-8') as f:
                      f.write('\n'.join(channels))
                  print(f"âœ… {xml_file}: å…±æå– {len(channels)} ä¸ªé¢‘é“ï¼Œå·²ä¿å­˜åˆ° {output_file}")
              except Exception as e:
                  print(f"âŒ è§£æ {xml_file} å‡ºé”™: {e}")

          extract_names('twepg.xml', 'ç¹é«”é›»è¦–å°ç›®éŒ„.txt')
          extract_names('swepg.xml', 'ç®€ä½“ç”µè§†å°ç›®å½•.txt')
          EOF

      - name: Commit and push results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "ç¹é«”é›»è¦–å°ç›®éŒ„.txt" "ç®€ä½“ç”µè§†å°ç›®å½•.txt" "traditional_channels.json" "simplified_channels.json"
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update channel name lists and JSON analysis"
            git push
          fi
