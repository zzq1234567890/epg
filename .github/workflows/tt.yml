name: Update EPG Summary

on:
  schedule:
    - cron: "0 */6 * * *"   # æ¯ 6 å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œå¯è‡ªè¡Œè°ƒæ•´
  workflow_dispatch:       # æ‰‹åŠ¨è§¦å‘

jobs:
  update_epg:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install lxml requests

      - name: Generate EPG summary
        run: |
          python3 << 'EOF'
          import requests
          from lxml import etree
          from datetime import datetime
          import os

          url = "https://raw.githubusercontent.com/zzq1234567890/epg/refs/heads/main/twepg.xml"
          r = requests.get(url)
          r.raise_for_status()

          root = etree.fromstring(r.content)

          rows = []
          for channel in root.findall(".//channel"):
              channel_id = channel.get("id", "")
              display_name = channel.findtext("display-name", default="æœªçŸ¥é¢‘é“")

              # è¯¥é¢‘é“æ‰€æœ‰èŠ‚ç›®
              progs = root.findall(f".//programme[@channel='{channel_id}']")
              prog_count = len(progs)

              if prog_count > 0:
                  # ç¬¬ä¸€ä¸ªèŠ‚ç›®å¼€å§‹æ—¶é—´
                  start_time = datetime.strptime(progs[0].get("start")[:8], "%Y%m%d")
                  # æœ€åä¸€ä¸ªèŠ‚ç›®ç»“æŸæ—¶é—´
                  stop_time = datetime.strptime(progs[-1].get("stop")[:8], "%Y%m%d")
                  days = (stop_time - start_time).days + 1
              else:
                  days = 0

              rows.append((display_name, prog_count, days))

          # ç”Ÿæˆ Markdown è¡¨æ ¼
          table_md = "| é¢‘é“åç§° | èŠ‚ç›®æ•°é‡ | è¦†ç›–å¤©æ•° |\n|---------|---------|---------|\n"
          for name, cnt, days in rows:
              table_md += f"| {name} | {cnt} | {days} |\n"

          # æ›´æ–° README.mdï¼ˆä½¿ç”¨æ ‡è®°åŒºè‡ªåŠ¨æ›¿æ¢ï¼‰
          readme_path = "README.md"

          if os.path.exists(readme_path):
              with open(readme_path, "r", encoding="utf-8") as f:
                  content = f.read()
          else:
              content = ""

          start_tag = "<!-- EPG_TABLE_START -->"
          end_tag = "<!-- EPG_TABLE_END -->"

          new_block = f"{start_tag}\n{table_md}{end_tag}"

          if start_tag in content and end_tag in content:
              # æ›¿æ¢å·²æœ‰è¡¨æ ¼
              old_block = content[content.index(start_tag): content.index(end_tag) + len(end_tag)]
              content = content.replace(old_block, new_block)
          else:
              # åœ¨æœ«å°¾æ·»åŠ 
              content += "\n\n## ğŸ“º EPG ä¿¡æ¯ç»Ÿè®¡\n" + new_block

          with open(readme_path, "w", encoding="utf-8") as f:
              f.write(content)

          print("README.md updated.")
          EOF

      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Update EPG summary"
          git push
