      - name: Generate EPG summary & HTML
        run: |
          python3 << 'EOF'
          import requests
          from lxml import etree
          from datetime import datetime
          import os, json

          url = "https://raw.githubusercontent.com/zzq1234567890/epg/refs/heads/main/twepg.xml"
          r = requests.get(url)
          r.raise_for_status()

          root = etree.fromstring(r.content)

          rows = []
          for channel in root.findall(".//channel"):
              channel_id = channel.get("id", "")
              display_name = channel.findtext("display-name", default="æœªçŸ¥é¢‘é“")

              progs = root.findall(f".//programme[@channel='{channel_id}']")
              prog_count = len(progs)

              if prog_count > 0:
                  start_time = datetime.strptime(progs[0].get("start")[:8], "%Y%m%d")
                  stop_time = datetime.strptime(progs[-1].get("stop")[:8], "%Y%m%d")
                  days = (stop_time - start_time).days + 1
              else:
                  days = 0

              rows.append((display_name, prog_count, days))

          # æ’åºï¼ˆèŠ‚ç›®æ•°å¤šçš„åœ¨å‰ï¼‰
          rows.sort(key=lambda x: x[1], reverse=True)

          # æ›´æ–° README.md
          table_md = "| é¢‘é“åç§° | èŠ‚ç›®æ•°é‡ | è¦†ç›–å¤©æ•° |\n|---------|---------|---------|\n"
          for name, cnt, days in rows:
              table_md += f"| {name} | {cnt} | {days} |\n"

          readme_path = "README.md"
          if os.path.exists(readme_path):
              with open(readme_path, "r", encoding="utf-8") as f:
                  content = f.read()
          else:
              content = ""

          start_tag = "<!-- EPG_TABLE_START -->"
          end_tag = "<!-- EPG_TABLE_END -->"
          new_block = f"{start_tag}\n{table_md}{end_tag}"

          if start_tag in content:
              old_block = content[content.index(start_tag): content.index(end_tag) + len(end_tag)]
              content = content.replace(old_block, new_block)
          else:
              content += "\n\n## ğŸ“º EPG ä¿¡æ¯ç»Ÿè®¡\n" + new_block

          with open(readme_path, "w", encoding="utf-8") as f:
              f.write(content)

          # ç”Ÿæˆ epg.html
          template = open("epg.html.template", "r", encoding="utf-8").read() if os.path.exists("epg.html.template") else """
          REPLACED_BY_PYTHON
          """

          # ä½¿ç”¨å†…åµŒæ¨¡æ¿
          html = """<!DOCTYPE html>
          <html lang="zh">
          <head>
          <meta charset="UTF-8">
          <title>EPG å¯è§†åŒ–ç»Ÿè®¡</title>
          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
          <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
          <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
          <style>
          body { font-family: Arial; margin: 20px; }
          h2 { margin-top:40px; }
          </style>
          </head>
          <body>

          <h1>ğŸ“º EPG å¯è§†åŒ–ç»Ÿè®¡</h1>

          <canvas id="progChart" width="600" height="300"></canvas>

          <h2>é¢‘é“è¯¦æƒ…è¡¨æ ¼</h2>
          <table id="epgTable" class="display">
            <thead>
              <tr><th>é¢‘é“</th><th>èŠ‚ç›®æ•°</th><th>è¦†ç›–å¤©æ•°</th></tr>
            </thead>
            <tbody>
              <!-- DATA_ROWS -->
            </tbody>
          </table>

          <script>
          const channelNames = """ + json.dumps([x[0] for x in rows], ensure_ascii=False) + """;
          const programmeCounts = """ + json.dumps([x[1] for x in rows], ensure_ascii=False) + """;
          const daysCoverage = """ + json.dumps([x[2] for x in rows], ensure_ascii=False) + """;

          new Chart(document.getElementById("progChart"), {
            type: "bar",
            data: {
              labels: channelNames,
              datasets: [{
                label: "èŠ‚ç›®æ•°é‡",
                data: programmeCounts,
                backgroundColor: "rgba(54, 162, 235, 0.6)"
              }]
            }
          });

          $(document).ready(function () {
            $('#epgTable').DataTable();
          });
          </script>

          </body>
          </html>
          """

          # æ’å…¥è¡¨æ ¼è¡Œ
          rows_html = ""
          for n, c, d in rows:
              rows_html += f"<tr><td>{n}</td><td>{c}</td><td>{d}</td></tr>\n"

          html = html.replace("<!-- DATA_ROWS -->", rows_html)

          with open("epg.html", "w", encoding="utf-8") as f:
              f.write(html)

          print("Generated epg.html")
          EOF
